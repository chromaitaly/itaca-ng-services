/*******************************************************************************
********************************************************************************
********************************************************************************
***	   itaca-ng-services														 
***    Copyright (C) 2016   Chroma Italy Hotels srl	 
***                                                                          
***    This program is free software: you can redistribute it and/or modify  
***    it under the terms of the GNU General Public License as published by  
***    the Free Software Foundation, either version 3 of the License, or     
***    (at your option) any later version.                                   
***                                                                          
***    This program is distributed in the hope that it will be useful,       
***    but WITHOUT ANY WARRANTY; without even the implied warranty of        
***    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         
***    GNU General Public License for more details.                          
***                                                                          
***    You should have received a copy of the GNU General Public License     
***    along with this program.  If not, see <http://www.gnu.org/licenses/>. 
********************************************************************************
********************************************************************************
*******************************************************************************/
!function(){"use strict";angular.module("itaca.services",["ngMaterial","itaca.utils","pascalprecht.translate","tmh.dynamicLocale","LocalStorageModule"])}(),function(){"use strict";function e(e,t){var o={};o.url="https://restcountries.eu/rest/v2";var n=function(e,t){var o=t();return delete o["X-Requested-With"],delete o["x-requested-with"],e};return o.methods={all:{method:"GET",url:service.url+"/all",isArray:!0,transformRequest:n},getByName:{method:"GET",url:service.url+"/name/:name",isArray:!0,transformRequest:n},getByIso:{method:"GET",url:service.url+"/alpha/:iso",transformRequest:n}},o.API=e(o.url+"/all",{},methods),service.all=function(){var e=t.defer();return o.API.all().$promise.then(function(t){e.resolve(t)},function(t){e.reject(t.data&&t.data.message?t.data.message:"Error getting countries")}),e.promise},service.getByName=function(e){var n=t.defer();return e?(o.API.getByName({name:e}).$promise.then(function(e){n.resolve(e)},function(e){n.reject(e.data&&e.data.message?e.data.message:"Error getting country")}),n.promise):(n.reject("Name not defined"),n.promise)},service.getByIso=function(e){var n=t.defer();return e?(o.API.getByIso({iso:e}).$promise.then(function(e){n.resolve(e)},function(e){n.reject(e.data&&e.data.message?e.data.message:"Error getting country")}),n.promise):(n.reject("ISO code not defined"),n.promise)},o.all=function(){var e=t.defer();return o.API.query().$promise.then(function(t){e.resolve(t)},function(t){e.reject(t.message?t.message:"")}),e.promise},o}e.$inject=["$resource","$q"],angular.module("itaca.services").factory("Country",e)}(),function(){"use strict";function e(e,t,o,n,r,i,a,s,c){var u=this;this.$$cookieName=$$cookieName,this.$$ratesCookieName=$$ratesCookieName,this.API=n("https://api.fixer.io/latest"),this.current={iso:"EUR",symbol:"â‚¬",rate:1},this.$init=function(){u.set()},this.all=function(){var e=o.defer(),t={importants:{},others:{}};if(u.supported){var n=_.pickBy(i.getCurrencies(),function(e,t){return!_.isNil(u.supported[t])||t==u.current.iso});_.forEach(n,function(e,o){o==u.current.iso?(t.current=n[o],t.current.key=o):"EUR"==o||"USD"==o||"AUD"==o||"CAD"==o||"GBP"==o||"CNY"==o||"JPY"==o?t.importants[o]=n[o]:t.others[o]=n[o]}),e.resolve(t)}else u.set().then(function(){u.all().then(function(t){e.resolve(t)})});return e.promise},this.get=function(e){if(_.isNil(e))return null;var t=i.getCurrencyByCode(e);return _.isNil(t)?null:t},this.set=function(e){_.isNil(e)&&(e=t.get(u.$$cookieName),_.isNil(e)&&(e="EUR"));var n=o.defer(),r=u.get(e);return _.isNil(r)?(n.reject("Currency not supported: "+e),n.promise):(u.getExchangeForCurrency(e).then(function(o){u.supported=o.rates,t.put(u.$$cookieName,e),a.currentCurrency=e,_.assign(u.current,{iso:e,symbol:r.symbol,rate:u.supported&&u.supported[e]?u.supported[e]:1}),n.resolve(u.current)},function(e){n.reject(e)}),n.promise)},this.getExchangeForCurrency=function(e,t){var n=o.defer(),i=u.get(e);if(_.isNil(i))return n.reject("Currency not supported: "+e),n.promise;var a=r.get(u.$$ratesCookieName);_.isArray(a)?_.some(a,function(e){return!!_.isNil(e.date)||(moment.isDate(e.date)?moment(e.date):moment(e.date,"YYYY-MM-DD")).isBefore(moment(),"days")})&&(a=[],r.remove(u.$$ratesCookieName)):(a=[],r.remove(u.$$ratesCookieName));var s=_.find(a,function(t){return t.base.iso==e&&!_.isEmpty(t.rates)});return s&&!t?n.resolve(s):u.API.get({base:e}).then(function(t){(s=t.data).base={iso:t.data.base,symbol:i.symbol},s.date=new Date,a=a||[];var o=_.findIndex(a,function(t){return t.base.iso==e&&!_.isEmpty(t.rates)});o>=0?a[o]=s:a.push(s),r.set(u.$$ratesCookieName,a),n.resolve(s)},function(e){n.reject(e)}),n.promise},this.getExchangeForCurrencyCached=function(t){var o=u.get(t);if(_.isNil(o))return e.warn("Currency not supported: "+t),null;var n=r.get(u.$$ratesCookieName);return _.isArray(n)?_.some(n,function(e){return!!_.isNil(e.date)||(moment.isDate(e.date)?moment(e.date):moment(e.date,"YYYY-MM-DD")).isBefore(moment(),"days")})&&(n=[],r.remove(u.$$ratesCookieName)):(n=[],r.remove(u.$$ratesCookieName)),_.find(n,function(e){return e.base.iso==t&&!_.isEmpty(e.rates)})},this.init()}angular.module("itaca.services").provider("Currency",function(){var t="X-ITACA-CURRENCY",o="X-ITACA-CURRENCY-RATES";this.init=function(e){e&&(e.cookieName&&($cookieName=e.cookieName),e.postUrl&&(o=e.ratesCookieName))},this.setCookieName=function(e){_.isString(e)&&(t=e)},this.setRatesCookieName=function(e){_.isString(e)&&(o=e)},this.$get=["$log","$cookies","$q","$resource","localStorageService","iso4217","AppOptions",function(n,r,i,a,s,c,u){return new e(n,r,i,a,s,c,u,t,o)}]})}(),function(){"use strict";function e(e,t,o,n){var r={};return r.autocompleteSvc=new google.maps.places.AutocompleteService,r.placesSvc=new google.maps.places.PlacesService(document.createElement("div")),r.geocoderSvc=new google.maps.Geocoder,r.cities=function(e,t){var n=o.defer();return r.autocompleteSvc.getPlacePredictions({input:e,types:["(cities)"],componentRestrictions:{country:t}},function(e,t){t!=google.maps.places.PlacesServiceStatus.OK?n.reject("Error getting cities: "+t):n.resolve(e)}),n.promise},r.addresses=function(e,t){var n=o.defer();return this.autocompleteSvc.getPlacePredictions({input:e,types:["address"],componentRestrictions:{country:t}},function(e,t){t!=google.maps.places.PlacesServiceStatus.OK?n.reject("Error getting addresses: "+t):n.resolve(e)}),n.promise},r.zipCodes=function(e,t){var n=o.defer();return r.geocoderSvc.geocode({componentRestrictions:{country:t,postalCode:e}}).$promise.then(function(e){n.resolve(e.results)},function(e){n.reject(e.data&&e.data.message?e.data.message:"Error getting zip codes")}),n.promise},r.latLong=function(e){var t=o.defer();return r.geocoderSvc.geocode({address:e},function(e,o){"OK"==data.status?t.resolve(data.results[0]):t.reject("Error getting latlong : "+data.status)},function(e){n.error("Error getting latlong: "+response.statusText+" (code: "+response.status+")"),t.reject("Error getting latlong")}),t.promise},r}e.$inject=["$http","$resource","$q","$log"],angular.module("itaca.services").factory("GoogleAPI",e)}(),function(){"use strict";function e(e,t){var o={};return o.start=function(e){if(o.$$loadingEl)o.updateOpts({data:e});else{var n={data:e,active:!0};o.$$loadingEl=t.addElement('<ch-loading-progress ng-if="data.active" message="data.message" message-key="data.messageKey" error-message="data.error ? data.errorMessage : \'\'" error-message-key="data.error ? data.errorMessageKey : \'\'" hide-siblings="data.active"></ch-loading-progress>',n,null,!0)}},o.stop=function(t,n){o.updateOpts({error:_.isBoolean(t)?t:!_.isNil(t)}),e(function(){o.updateOpts({active:!1})},n||0)},o.updateOpts=function(e){_.isPlainObject(e)&&o.$$loadingEl&&_.assign(o.$$loadingEl.scope(),e)},o}e.$inject=["$timeout","HtmlUtils"],angular.module("itaca.services").factory("LoadingProgress",e)}(),function(){"use strict";function e(e,t,o){var n={};return n.start=function(e){if(n.$$loadingEl)n.updateOpts({data:e});else{var t={data:e,active:!0};n.$$loadingEl=o.addElement('<ch-loading-progress ng-if="data.active" message="data.message" message-key="data.messageKey"></ch-loading-progress>',t,null,!0)}},n.stop=function(e,o){t(function(){n.updateOpts({active:!1})},o||0)},n.updateOpts=function(e){_.isPlainObject(e)&&n.$$loadingEl&&_.assign(n.$$loadingEl.scope(),e)},n}e.$inject=["$rootScope","$timeout","HtmlUtils"],angular.module("itaca.services").factory("Loading",e)}(),function(){"use strict";function e(e,t,o,n,r,i,a,s,c,u){var l=this;this.$$cookieName=c,this.API=a(u),this.supported=function(){return[{iso:"it",label:o.instant("language.italian"),flag:"it"},{iso:"en",label:o.instant("language.english"),flag:"gb"}]},this.current=function(){var o=e.get(l.$$cookieName);_.isNil(o)&&(o=t.navigator.language||t.navigator.userLanguage),o=o.split("-")[0];var n=l.get(o);return _.isNil(n)&&(n=l.get(s.defaultLang)),n},this.get=function(e){if(_.isNil(e))return null;e=e.split("-")[0];var t,o=l.supported();for(t in o){var n=o[t];if(_.isEqual(n.iso,e))return n}return null},this.set=function(a){_.isNil(a)&&(a=e.get(l.$$cookieName),_.isNil(a)&&(a=t.navigator.language||t.navigator.userLanguage)),a=a.split("-")[0];var s=i.defer(),c=l.get(a);return _.isNil(c)?(s.reject("Language not supported: "+a),s.promise):(l.API.save({lang:a}).$promise.then(function(t){o.use(a),n.set(a),r.changeLocale(a),e.put(l.$$cookieName,c.iso),s.resolve(l.current())},function(e){s.reject("Error setting locale: "+(e.data?e.data.message:""))}),s.promise)}}angular.module("itaca.services").provider("Locale",function(){var t="X-ITACA-LOCALE",o="/api/rs/public/lang/:lang";this.init=function(e){e&&(e.cookieName&&($cookieName=e.cookieName),e.postUrl&&(o=e.postUrl))},this.setCookieName=function(e){_.isString(e)&&(t=e)},this.setUrl=function(e){_.isString(e)&&(o=e)},this.$get=["$cookies","$window","$translate","tmhDynamicLocale","amMoment","$q","$resource","AppOptions",function(n,r,i,a,s,c,u,l){return new e(n,r,i,a,s,c,u,l,t,o)}]})}(),function(){"use strict";function e(e,t,o,n,r,i,a,s,c,u){var l={};return l.logout=function(){n.info("Logging out..."),e.post("logout",{}).then(function(){n.info("Logout success. Going back to home...")},function(e){n.error("Logout failed!")}).finally(l.home)},l.login=function(){location.assign("/login")},l.home=function(){location.assign("/")},l.go=function(e,o,n){o?location.assign(e):n?t.open(e):r.url(e)},l.goToState=function(e,t,o){c.go(e,t,o)},l.reload=function(){t.location.reload()},l.reloadState=function(e,t){e?c.transitionTo(e,t,{reload:!0,inherit:!1,notify:!0}):c.reload()},l.redirect=function(e){i(function(){r.url("/"+e)},5e3)},l.goToAnchor=function(e){if(e){e=e.startsWith("#")?e.substring(1):e;var t=document.getElementById(e);null!=t&&o.scrollToElementAnimated(angular.element(t))}},service.scrollToAnchor=function(e){e&&(e=e.startsWith("#")?e.substring(1):e,a(e))},l.top=function(e){o.scrollTopAnimated(0),e&&(window.onload=function(){o.scrollTopAnimated(0)})},l.toggleLeftMenu=function(){s("leftMenu").toggle(),AppOptions.hideLeftMenu=!AppOptions.hideLeftMenu},l.closeLeftMenu=function(e){s("leftMenu").close(),AppOptions.hideLeftMenu=e},l.isLeftMenuOpen=function(){return s("leftMenu").isOpen()},l.top=function(){o.scrollTopAnimated(0)},l.historyBack=function(){t.history.back()},l.back=function(){u.$broadcast("back")},l.next=function(e){u.$broadcast("next",e)},l}e.$inject=["$http","$window","$document","$log","$location","$timeout","$anchorScroll","$mdSidenav","$state","$rootScope"],angular.module("itaca.services").factory("Navigation",e)}(),function(){"use strict";function e(e,t){var o={};return o.message=function(e,n,r){var i=t("gt-sm")?"top right":"top";o.showSimple(e,n,r,i,!0)},o.error=function(e,n){var r=t("gt-sm")?"top right":"top";o.showSimple(e,n,null,r,!1)},o.showSimple=function(t,o,n,r,i){var a=e.simple().textContent(t).position(r).capsule(i);angular.isDefined(n)&&a.action(n),e.show(a).then(function(e){angular.isDefined(o)&&o(e)})},o}e.$inject=["$mdToast","$mdMedia"],angular.module("itaca.services").factory("Notification",e)}();